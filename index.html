<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gtk Substitution Timetable</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    margin: 20px;
    background-color: #f4f6f9;
  }
  h1, h2 {
    text-align: center;
    color: #2c3e50;
  }
  .container {
    max-width: 1000px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  label {
    font-weight: bold;
  }
  select, input, button, textarea {
    margin: 5px;
    padding: 6px;
    border-radius: 5px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #999;
    padding: 6px;
    text-align: center;
  }
  th {
    background: #dfe6e9;
  }
  button {
    background: #3498db;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background: #2980b9;
  }
  .print-area {
    display: none;
  }
  @media print {
    body * { visibility: hidden; }
    .print-area, .print-area * { visibility: visible; }
    .print-area { position: absolute; left: 0; top: 0; width: 100%; }
  }
</style>
</head>
<body>

<div class="container">
  <h1>School Substitution Timetable</h1>

  <h2>1️⃣ One-Time Timetable Setup</h2>
  <label>Day:</label>
  <select id="dayInput">
    <option>Monday</option>
    <option>Tuesday</option>
    <option>Wednesday</option>
    <option>Thursday</option>
    <option>Friday</option>
  </select>
  <label>Class:</label>
  <input type="text" id="classInput" placeholder="e.g. 10A">
  <label>Period:</label>
  <input type="text" id="periodInput" placeholder="e.g. P1">
  <label>Teacher:</label>
  <input type="text" id="teacherInput" placeholder="e.g. Mr. Rao">
  <button onclick="addTimetable()">Add Entry</button>
  <button onclick="resetTimetable()">Reset All</button>

  <h3>Current Timetable Entries</h3>
  <table id="timetableDisplay">
    <tr><th>Day</th><th>Class</th><th>Period</th><th>Teacher</th></tr>
  </table>

  <h2>2️⃣ Today's Substitution</h2>
  <label>Absent Teachers (comma separated):</label><br>
  <textarea id="absentInput" rows="2" cols="50" placeholder="e.g. Mr. Rao, Ms. Devi"></textarea><br>
  <button onclick="generateSubstitution()">Generate Substitution</button>
  <button onclick="printSubstitution()">Print / Export</button>

  <div id="output"></div>
</div>

<!-- Print Area -->
<div class="print-area" id="printArea">
  <h2>Gtk Substitution Timetable</h2>
  <p id="printDateDay"></p>
  <p id="printAbsent"></p>
  <table id="printTable">
    <tr><th>Class</th><th>Period</th><th>Absent Teacher</th><th>Substitute Teacher</th></tr>
  </table>
  <h4>Substitution Count Summary</h4>
  <p id="substitutionSummary"></p>
</div>

<script>
let timetable = JSON.parse(localStorage.getItem("schoolTimetable")) || {};
let dutyCount = JSON.parse(localStorage.getItem("dutyCount")) || {};

function updateTableDisplay() {
  let table = document.getElementById("timetableDisplay");
  table.innerHTML = "<tr><th>Day</th><th>Class</th><th>Period</th><th>Teacher</th></tr>";
  for (let day in timetable) {
    for (let period in timetable[day]) {
      for (let cls in timetable[day][period]) {
        table.innerHTML += `<tr><td>${day}</td><td>${cls}</td><td>${period}</td><td>${timetable[day][period][cls]}</td></tr>`;
      }
    }
  }
}

function addTimetable() {
  let day = document.getElementById("dayInput").value;
  let cls = document.getElementById("classInput").value.trim();
  let period = document.getElementById("periodInput").value.trim();
  let teacher = document.getElementById("teacherInput").value.trim();
  if (!day || !cls || !period || !teacher) return alert("Please fill all fields");

  if (!timetable[day]) timetable[day] = {};
  if (!timetable[day][period]) timetable[day][period] = {};
  timetable[day][period][cls] = teacher;

  localStorage.setItem("schoolTimetable", JSON.stringify(timetable));
  updateTableDisplay();
}

function resetTimetable() {
  if (confirm("Clear all saved timetable data?")) {
    timetable = {};
    dutyCount = {};
    localStorage.removeItem("schoolTimetable");
    localStorage.removeItem("dutyCount");
    updateTableDisplay();
  }
}

function getCurrentDay() {
  const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  return days[new Date().getDay()];
}

function generateSubstitution() {
  let absent = document.getElementById("absentInput").value.split(",").map(a => a.trim()).filter(a => a);
  let today = getCurrentDay();
  let todayData = timetable[today];
  if (!todayData) return alert(`No timetable found for ${today}`);

  let allTeachers = new Set();
  for (let p in todayData) {
    for (let c in todayData[p]) allTeachers.add(todayData[p][c]);
  }
  let availableTeachers = [...allTeachers].filter(t => !absent.includes(t));

  let output = "<h3>Today's Substitution</h3>";
  output += `<p>Date: ${new Date().toLocaleDateString()} | Day: ${today}</p>`;
  output += `<p><b>Absent Teachers:</b> ${absent.join(", ") || "None"}</p>`;
  output += "<table><tr><th>Class</th><th>Period</th><th>Absent Teacher</th><th>Substitute Teacher</th></tr>";

  let subs = [];

  for (let p in todayData) {
    for (let c in todayData[p]) {
      let teacher = todayData[p][c];
      if (absent.includes(teacher)) {
        if (availableTeachers.length === 0) {
          subs.push({cls: c, period: p, absent: teacher, substitute: "No substitute available"});
          continue;
        }
        availableTeachers.sort((a,b)=>(dutyCount[a]||0)-(dutyCount[b]||0));
        let substitute = availableTeachers[0];
        subs.push({cls: c, period: p, absent: teacher, substitute});
        dutyCount[substitute] = (dutyCount[substitute] || 0) + 1;
      }
    }
  }

  localStorage.setItem("dutyCount", JSON.stringify(dutyCount));

  subs.forEach(s => {
    output += `<tr><td>${s.cls}</td><td>${s.period}</td><td>${s.absent}</td><td>${s.substitute}</td></tr>`;
  });
  output += "</table>";

  // Display duty summary
  output += "<h4>Substitution Count Summary</h4>";
  let summary = Object.entries(dutyCount).map(([t,c]) => `${t}: ${c}`).join(" | ");
  output += `<p>${summary || "No records yet."}</p>`;
  
  document.getElementById("output").innerHTML = output;

  // Prepare print area
  document.getElementById("printDateDay").innerText = `Date: ${new Date().toLocaleDateString()} | Day: ${today}`;
  document.getElementById("printAbsent").innerText = `Absent Teachers: ${absent.join(", ") || "None"}`;
  let printTable = document.getElementById("printTable");
  printTable.innerHTML = "<tr><th>Class</th><th>Period</th><th>Absent Teacher</th><th>Substitute Teacher</th></tr>";
  subs.forEach(s => {
    printTable.innerHTML += `<tr><td>${s.cls}</td><td>${s.period}</td><td>${s.absent}</td><td>${s.substitute}</td></tr>`;
  });
  document.getElementById("substitutionSummary").innerText = summary || "No records yet.";
}

function printSubstitution() {
  window.print();
}

updateTableDisplay();
</script>
</body>
</html>
